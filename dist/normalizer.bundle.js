!function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=5)}([function(e,t,n){"use strict";n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return c}));var r,o,i,a,l=n(1);!function(e){e.FATAL="fatal",e.ERROR="error",e.WARN="warn",e.INFO="info",e.DEBUG="debug",e.TRACE="trace"}(r||(r={})),function(e){e.ASSETS="assets",e.ASSET_HISTORY="asset_history",e.ASSET_TYPES="asset_types",e.AREAS="areas",e.ACTIONS="actions",e.EVENT_TYPES="event_types",e.EVENTS="events",e.EVENT_HISTORY="event_history",e.RULES="rules"}(o||(o={})),function(e){e.OVERWRITE="overwrite",e.MERGE="merge"}(i||(i={})),function(e){e.NO="no",e.ALL="all",e.CUSTOM="custom"}(a||(a={}));var u={LOG_SETTING:r.DEBUG,CUSTOM_CONFIGS:{},ASSET_HISTORY_CONFIG:{STANDARD_KEYS_TO_STORE:["location_x","location_y","location_z"],CUSTOM_DATA_KEYS_TO_STORE:[],LOG_SETTING:r.DEBUG,STANDARD_KEY_STORAGE_SETTING:a.CUSTOM,CUSTOM_DATA_KEY_STORAGE_SETTING:a.ALL,LOG_SERVICE_NAME:"AssetHistoryServiceNameUnset"},NORMALIZER_PUB_CONFIG:{locationConfig:{topicFn:l.a.DBUpdateAssetLocation,keysToPublish:["id","location_x","location_y","location_z","location_unit","location_type","latitude","longitude","last_updated","last_location_updated"]},statusConfig:{topicFn:l.a.DBUpdateAssetStatus,keysToPublish:["custom_data","id","type"]},historyConfig:{topicFn:l.a.AssetHistory,keysToPublish:["id","location_x","location_y","location_z","location_unit","location_type","latitude","longitude","last_updated","last_location_updated","custom_data","type"]},rulesConfig:{topicFn:l.a.RulesAssetLocation,keysToPublish:["id","location_x","location_y","location_z","location_unit","location_type","latitude","longitude","last_updated","last_location_updated","custom_data","type"]}},UPDATE_ASSET_LOCATION_OPTIONS:{KEYS_TO_UPDATE:["location_x","location_y","location_z","location_unit","location_type","latitude","longitude","last_updated","last_location_updated"],CREATE_NEW_ASSET_IF_MISSING:!1,LOG_SETTING:r.DEBUG,LOG_SERVICE_NAME:"AssetLocationServiceNameUnset"},UPDATE_ASSET_STATUS_OPTIONS:{UPDATE_METHOD:i.MERGE,LOG_SETTING:r.DEBUG,LOG_SERVICE_NAME:"AssetStatusServiceNameUnset"}};var c=u},function(e,t,n){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}n.d(t,"a",(function(){return o})),n.d(t,"b",(function(){return i}));var o={AssetLocation:function(e){return"_monitor/_asset/".concat(e,"/location")},RulesAssetLocation:function(e){return"_rules/_monitor/_asset/".concat(e)},DBUpdateAssetLocation:function(e){return"_dbupdate/_monitor/_asset/".concat(e,"/location")},HistoryAssetLocation:function(e){return"_history/_monitor/_asset/".concat(e,"/location")},AssetHistory:function(e){return"_history/_monitor/_asset/".concat(e,"/location")},DBUpdateAssetStatus:function(e){return"_dbupdate/_monitor/_asset/".concat(e,"/status")},AreaLocationEvent:function(e){return"_monitor/_area/".concat(e,"/location")},ListenAllAssetsLocation:function(){return"_monitor/_asset/+/location"},ListenAllAssetsStatus:function(){return"_monitor/_asset/+/status"}};function i(e){return e&&"object"===r(e)?e.stack?e.stack:e.message?e.message:JSON.stringify(e):e}},function(e,t,n){"use strict";function r(e){var t=ClearBlade.Messaging();return new Promise((function(n,r){t.subscribe(e,(function(e,t){e?r(new Error("Error with subscribing: "+JSON.stringify(t))):n(t)}))}))}Object.defineProperty(t,"__esModule",{value:!0}),n(3),t.subscriber=r,t.bulkSubscriber=function(e){return new Promise((function(t,n){Promise.all(e.map((function(e){r(e)}))).then((function(){t()})).catch((function(e){log("Subscription error: "+e.message),n(new Error(e))})),Promise.runQueue()}))}},function(e,t){!function(){var e=!0,t=null,n=null;function r(e){Object.setPrototypeOf(e,null),i(e),t?(n.next=e,i(n),n=e):(t=e,n=e)}function o(e,t,n,r){void 0===r&&(r="wc"),Object.defineProperty(e,t,{value:n,writable:r.indexOf("w")>=0,enumerable:r.indexOf("e")>=0,configurable:r.indexOf("c")>=0})}var i="object"==typeof Duktape&&Duktape.compact||function(e){return e},a=function(){},l="function"==typeof Symbol,u=l?Symbol("promise"):"__PromiseInstance__";function c(e){return null!==e&&"object"==typeof e&&u in e}function s(e){try{v.unhandledRejection(e)}catch(e){}}function f(e,t){try{"reject"===t?(s({promise:e,event:"rawReject",reason:e.value}),o(e,"unhandled",1),v.potentiallyUnhandled.push(e)):"handle"===t&&(s({promise:e,event:"rawHandle",reason:e.value}),2===e.unhandled?(o(e,"unhandled",3),v.potentiallyUnhandled.push(e)):delete e.unhandled)}catch(e){}}function d(e,t){if(void 0===e.state){e.state=!1,e.value=t;var n=e.rejectReactions;delete e.fulfillReactions,delete e.rejectReactions,i(e),n.forEach((function(e){e.value=t,e.handler||(e.rejected=!0),r(e)})),e.isHandled||f(e,"reject")}}function h(t){var n=!1;return{resolve:function(o){if(new.target)throw new TypeError("resolve is not constructable");if(!n&&(n=!0,void 0===t.state)){if(o===t)return d(t,new TypeError("self resolution"));try{var a=null!==o&&"object"==typeof o&&o.then;if("function"==typeof a){var l=h(t);return r(e?{thenable:o,then:a,target:t}:{thenable:o,then:a,resolve:l.resolve,reject:l.reject})}return function(e,t){if(void 0===e.state){e.state=!0,e.value=t;var n=e.fulfillReactions;delete e.fulfillReactions,delete e.rejectReactions,i(e),n.forEach((function(e){e.value=t,r(e)}))}}(t,o)}catch(e){return d(t,e)}}},reject:function(e){if(new.target)throw new TypeError("reject is not constructable");n||(n=!0,void 0===t.state&&d(t,e))}}}function p(){var e,r,o=((e=t)&&((t=e.next)||(n=null)),e);if(!o)return!1;if(o.then){o.target&&(r=h(o.target));try{r?o.then.call(o.thenable,r.resolve,r.reject):o.then.call(o.thenable,o.resolve,o.reject)}catch(e){r?r.reject.call(void 0,e):o.reject.call(void 0,e)}}else try{if(void 0===o.handler)return r=h(o.target),(r=o.rejected?r.reject:r.resolve).call(void 0,o.value),!0;if("Identity"===o.handler)res=o.value;else{if("Thrower"===o.handler)throw o.value;res=o.handler.call(void 0,o.value)}o.target?h(o.target).resolve.call(void 0,res):o.resolve.call(void 0,res)}catch(e){o.target?h(o.target).reject.call(void 0,e):o.reject.call(void 0,e)}return!0}var v=function(e){if(!new.target)throw new TypeError("Promise must be called as a constructor");if("function"!=typeof e)throw new TypeError("executor must be callable");o(this,u,!0,""),o(this,"state",void 0),o(this,"value",void 0),o(this,"fulfillReactions",[]),o(this,"rejectReactions",[]),o(this,"isHandled",!1),i(this);var t=h(this);try{e(t.resolve,t.reject)}catch(e){t.reject(e)}},y=v.prototype;function b(e){return c(e)&&e.constructor===this?e:new Promise((function(t,n){t(e)}))}function _(e){return new Promise((function(t,n){n(e)}))}function g(e){if(!Array.isArray(e))throw new TypeError("non-array all() argument not supported");var t,n,r=new Promise((function(e,r){t=e,n=r})),o=[],i=0,a=1;return e.forEach((function(e){var r=Promise.resolve(e),l=function e(n){var r=e;r.alreadyCalled||(r.alreadyCalled=!0,o[r.index]=n,0==--a&&t.call(void 0,o))};l.index=i++,a++,r.then(l,n)})),0==--a&&t.call(void 0,o),r}function S(t){if(!Array.isArray(t))throw new TypeError("non-array race() argument not supported");var n,o,i=new Promise((function(e,t){n=e,o=t}));return t.forEach((function(t){var a=Promise.resolve(t),l=a.then;l===m&&e?function(e,t){void 0===e.state?(e.fulfillReactions.push({target:t}),e.rejectReactions.push({target:t})):e.state?r({target:t,value:e.value}):(e.isHandled||f(e,"handle"),r({target:t,value:e.value,rejected:!0}));e.isHandled=!0}(a,i):l.call(a,n,o)})),i}function m(t,n){var o,i;!function(e){if(!c(e))throw new TypeError("Promise required")}(this);var a=new Promise((function(e,t){o=e,i=t})),l=e;return"function"!=typeof t&&(t="Identity"),"function"!=typeof n&&(n="Thrower"),void 0===this.state?l?(this.fulfillReactions.push({handler:t,target:a}),this.rejectReactions.push({handler:n,target:a})):(this.fulfillReactions.push({handler:t,resolve:o,reject:i}),this.rejectReactions.push({handler:n,resolve:o,reject:i})):this.state?r(l?{handler:t,target:a,value:this.value}:{handler:t,resolve:o,reject:i,value:this.value}):(this.isHandled||f(this,"handle"),r(l?{handler:n,target:a,value:this.value}:{handler:n,resolve:o,reject:i,value:this.value})),this.isHandled=!0,a}o(v,"prototype",y,""),o(v,"potentiallyUnhandled",[],"");var E=function(e){return this.then.call(this,void 0,e)};o(E,"name","catch","c");var O=function(e){return new this((function(t,n){t(e())}))};function T(){var e;for(e=0;e<v.potentiallyUnhandled.length;e++){var t=v.potentiallyUnhandled[e];v.potentiallyUnhandled[e]=null,1===t.unhandled?(s({promise:t,event:"reject",reason:t.value}),o(t,"unhandled",2)):3===t.unhandled&&(s({promise:t,event:"handle",reason:t.value}),delete t.unhandled)}return v.potentiallyUnhandled.length=0,e>0}o(O,"name","try","c"),function(){o(this,"Promise",v),o(v,"resolve",b),o(v,"reject",_),o(v,"all",g),o(v,"race",S),o(v,"try",O),o(v,"isPolyfill",!0),o(y,"then",m),o(y,"catch",E),l&&o(y,Symbol.toStringTag,"Promise","c"),o(v,"runQueue",(function(){console.log("run queue!!!");do{for(;p(););T()}while(t||0!==v.potentiallyUnhandled.length)})),o(v,"unhandledRejection",a),i(this),i(v),i(y)}()}()},function(e,t,n){"use strict";function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function a(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.length>0?"".concat(t.map((function(e){return"object"===i(e)?JSON.stringify(e):e})).join(" ")):""}function l(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return a.apply(void 0,[e.name].concat(n))}n.d(t,"a",(function(){return c}));var u={name:"NameNotSet",logSetting:n(0).a.LOG_SETTING},c=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:u,n=t.name,r=void 0===n?u.name:n,i=t.logSetting,a=void 0===i?u.logSetting:i;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),o(this,"name",void 0),o(this,"logSetting",void 0),o(this,"levels",{trace:1,debug:2,info:3,warn:4,error:5,fatal:6}),this.name=r,this.logSetting=a}var t,n,i;return t=e,(n=[{key:"levelToInt",value:function(e){return e.toLowerCase()in this.levels?this.levels[e.toLowerCase()]:99}},{key:"publishLog",value:function(e){for(var t=ClearBlade.Messaging(),n=arguments.length,r=new Array(n>1?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];var i=l({name:this.name},r),a=this.levelToInt(e),u=this.levelToInt(this.logSetting||"");a<u||t.publish(e,i)}}])&&r(t.prototype,n),i&&r(t,i),e}()},function(e,t,n){"use strict";n.r(t),function(e){n.d(t,"publisher",(function(){return c})),n.d(t,"bulkPublisher",(function(){return s})),n.d(t,"publishExternalEvent",(function(){return f})),n.d(t,"normalizer",(function(){return d})),n.d(t,"api",(function(){return h}));var r=n(4),o=n(0),i=n(1),a=n(2);n.d(t,"subscriber",(function(){return a.subscriber})),n.d(t,"bulkSubscriber",(function(){return a.bulkSubscriber}));n(3);function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e,t){for(var n=ClearBlade.Messaging(),r=function(r,o){var i=e[r].id,a=t.topicFn(i),l={};t.keysToPublish.forEach((function(t){l[t]=e[r][t]})),(void 0===t.shouldPublishAsset||t.shouldPublishAsset(l))&&n.publish(a,JSON.stringify(l))},o=0,i=e.length;o<i;o++)r(o)}function s(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o.a.NORMALIZER_PUB_CONFIG;Object.keys(t).forEach((function(n){c(e,t[n])}))}function f(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:i.a.RulesAssetLocation;ClearBlade.Messaging().publish(n(e.id),JSON.stringify(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){u(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},e,{meta:{rule_id:t,is_external_rule_type:!0}})))}function d(e){var t=e.messageParser,n=e.normalizerPubConfig||o.a.NORMALIZER_PUB_CONFIG,l=e.logServiceName||"Normalizer",u=e.logSetting||o.b.DEBUG,c=e.topics[0],f=e.req.service_instance_id,d=ClearBlade.Messaging(),h=new r.a({name:l,logSetting:u});h.publishLog(o.b.DEBUG,"Normalizer SERVICE_INSTANCE_ID:: "+f);for(var p=[],v=0,y=e.topics.length;v<y;v++)p.push(Object(a.subscriber)(e.topics[v]));function b(e){h.publishLog(o.b.ERROR,"Failed ",Object(i.b)(e))}function _(r,o,i){r&&e.resp.error("HandleMessage error inside Normalizer. Service was probably killed while waiting for messages. ".concat(JSON.stringify({err:r,msg:o,topic:i}))),t(r,o,i).then((function(e){s(e,n)})).catch(b),Promise.runQueue()}Promise.all(p).then((function(){for(h.publishLog(o.b.INFO,"Subscribed to Shared Topics. Starting Loop.");;)d.waitForMessage([c],_)})).catch(b),Promise.runQueue()}e.normalizer=d,e.publishExternalEvent=f;var h={default:d,publisher:c}}.call(this,n(6))},function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n}]);